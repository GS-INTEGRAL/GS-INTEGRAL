<odoo>

    <template id="portal_helpdesk_form_inherit" inherit_id="website_helpdesk.team_form_1">
        <xpath expr="//div[input[@name='partner_email']]" position="after">
            <t t-if="request.env.user.partner_id">
               
                 <!-- Campo Sede/Obra -->
                <div class="mb-0 py-2 s_website_form_field col-12">
                    <div class="row s_col_no_resize s_col_no_bgcolor">
                        <label class="col-form-label col-sm-auto s_website_form_label" style="width: 200px">
                            <span class="s_website_form_label_content">Sede/Obra</span>
                        </label>
                        <div class="col-sm">
                            <!-- <select class="form-control s_website_form_input" name="obra_secundaria" id="helpdesk_obra_secundaria">
                                <t t-foreach="obras" t-as="obra">
                                    <option t-att-value="obra.id"><t t-esc="obra.name" /></option>
                                </t>
                            </select>  -->
                            <select class="form-control s_website_form_input" name="obra_secundaria" id="helpdesk_obra_secundaria">
                                <t t-foreach="request.env['res.partner.obra_secundaria'].sudo().search([])" t-as="obra">
                                    <option t-att-value="obra.id"><t t-esc="obra.name"/></option>
                                </t>
                            </select>  
                           <input type="text" class="form-control mt-2 d-none" id="new_obra_secundaria" name="new_obra_secundaria" placeholder="Nombre de la nueva Sede/Obra"/>      
                        </div>
                    </div>
                </div>

                <!-- Campo Estancia -->
                <div class="mb-0 py-2 s_website_form_field col-12">
                    <div class="row s_col_no_resize s_col_no_bgcolor">
                        <label class="col-form-label col-sm-auto s_website_form_label" style="width: 200px">
                            <span class="s_website_form_label_content">Estancia</span>
                        </label>
                        <div class="col-sm">
                           <!-- <select class="form-control s_website_form_input" name="estancia_id" id="helpdesk_estancia_id">
                                <t t-foreach="estancias" t-as="estancia">
                                    <option t-att-value="estancia.id"><t t-esc="estancia.name" /></option>
                                </t>
                            </select> -->
                            
                            <select class="form-control s_website_form_input" name="estancia_id" id="helpdesk_estancia_id">
                                  <t t-foreach="request.env['res.partner.estancia_id'].sudo().search([])" t-as="estancia">
                                    <option t-att-value="estancia.id"><t t-esc="estancia.name"/></option>
                                </t>
                            </select>
                            <input type="text" class="form-control mt-2 d-none" id="new_estancia" name="new_estancia" placeholder="Nombre de la nueva Estancia"/>
                        </div>
                    </div>
                </div>

                <!-- Campo Categoría -->
                <div class="mb-0 py-2 s_website_form_field col-12" data-type="selection" data-name="categoria">
                    <div class="row s_col_no_resize s_col_no_bgcolor">
                        <label class="col-form-label col-sm-auto s_website_form_label" style="width: 200px" for="helpdesk_categoria">
                            <span class="s_website_form_label_content">Categoría</span>
                        </label>
                        <div class="col-sm">
                            <select class="form-control s_website_form_input" name="categoria" id="helpdesk_categoria">
                                <option value="bricolage">Bricolaje</option>
                                <option value="fontaneria">Fontanería</option>
                                <option value="climatizacion">Climatización</option>
                                <option value="electricidad">Electricidad</option>
                                <option value="albañileria">Albañilería</option>
                                <option value="varios">Varios</option>
                                <option value="tic-ordenadores">Tic-Ordenadores</option>
                                <option value="mantenimiento">Mantenimiento</option>
                                <option value="pintura">Pintura</option>
                                <option value="herreria">Herrería</option>
                                <option value="jardineria">Jardinería</option>
                                <option value="carpinteria">Carpintería</option>
                                <option value="cristaleria">Cristalería</option>
                            </select>
                        </div>
                    </div>
                </div>
            </t>
        </xpath>
        <xpath expr="//form" position="after">
        <script type="text/javascript">
            $(document).ready(function() {
                $('#helpdesk_obra_secundaria').change(function() {
                    if ($(this).val() === 'new') {
                        $('#new_obra_secundaria').removeClass('d-none');
                    } else {
                        $('#new_obra_secundaria').addClass('d-none');
                    }
                });
                
                $('#helpdesk_estancia_id').change(function() {
                    if ($(this).val() === 'new') {
                        $('#new_estancia').removeClass('d-none');
                    } else {
                        $('#new_estancia').addClass('d-none');
                    }
                });

                $('form').on('submit', function(e) {
                    if ($('#helpdesk_obra_secundaria').val() === 'new') {
                        e.preventDefault();
                        var newObraName = $('#new_obra_secundaria').val();
                        $.ajax({
                            url: '/custom_helpdesk/create_obra',
                            type: 'POST',
                            data: JSON.stringify({name: newObraName}),
                            contentType: 'application/json',
                            dataType: 'json',
                            success: function(result) {
                                $('#helpdesk_obra_secundaria').append($('<option>', {
                                    value: result.id,
                                    text: result.name
                                }));
                                $('#helpdesk_obra_secundaria').val(result.id);
                                $('#new_obra_secundaria').addClass('d-none');
                                $('form').submit();
                            }
                        });
                    }
                    if ($('#helpdesk_estancia_id').val() === 'new') {
                        e.preventDefault();
                        var newEstanciaName = $('#new_estancia').val();
                        $.ajax({
                            url: '/custom_helpdesk/create_estancia',
                            type: 'POST',
                            data: JSON.stringify({name: newEstanciaName}),
                            contentType: 'application/json',
                            dataType: 'json',
                            success: function(result) {
                                $('#helpdesk_estancia_id').append($('<option>', {
                                    value: result.id,
                                    text: result.name
                                }));
                                $('#helpdesk_estancia_id').val(result.id);
                                $('#new_estancia').addClass('d-none');
                                $('form').submit();
                            }
                        });
                    }
                });
            });
        </script>
    </xpath>
    </template>
    
</odoo>
